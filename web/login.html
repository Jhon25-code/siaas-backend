<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SIAAS | Acceso</title>

    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="stylesheet" href="/css/styles.css" />
</head>

<body class="loginPage">

<script>
    try {
      const token = localStorage.getItem('token');
      // Verificación básica de que el token existe y parece un JWT
      if (token && token.split('.').length === 3) {
        window.location.href = '/dashboard.html';
      } else {
        localStorage.clear(); // Si es inválido, limpiar
      }
    } catch (e) {
      localStorage.clear();
    }
</script>

<section class="loginHero" aria-hidden="true"></section>

<main class="loginWrap">
    <section class="loginCard" aria-label="Acceso al sistema">

        <header class="brand">
            <img
                    class="brandLogo"
                    src="/images/logo_siaas.png"
                    alt="Logo SIAAS"
                    onerror="this.style.display='none'"
            />
            <div class="brandText">
                <h1>SIAAS</h1>
                <p>Sistema inteligente de alertas agrícolas</p>
            </div>
        </header>

        <div class="divider"></div>

        <form
                id="loginForm"
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
        >
            <label for="username">Usuario</label>
            <input
                    id="username"
                    name="username"
                    type="text"
                    placeholder="topico / admin / supervisor"
                    required
                    autofocus
            />

            <label for="password">Contraseña</label>
            <input
                    id="password"
                    name="password"
                    type="password"
                    placeholder="Siaas2026"
                    required
            />

            <button class="btnPrimary" type="submit" id="btnSubmit">
                Ingresar
            </button>

            <p id="msg" class="error" aria-live="polite" style="color: #d32f2f; margin-top: 1rem; font-weight: 500;"></p>
        </form>

        <footer class="loginFooter">
            © <span id="year"></span> Agroindustrial · SIAAS
        </footer>

    </section>
</main>

<script>
    document.getElementById('year').textContent = new Date().getFullYear();
</script>

<script>
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // Evitar recarga de página

        const msgElement = document.getElementById('msg');
        const btnSubmit = document.getElementById('btnSubmit');
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        // 1. Estado de carga visual
        msgElement.textContent = '';
        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Verificando...';
        btnSubmit.style.opacity = '0.7';

        try {
            // 2. Limpieza preventiva de localStorage
            localStorage.clear();

            // 3. Petición al Backend
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Error de credenciales');
            }

            // 4. ✅ ÉXITO: Guardar el token correctamente
            localStorage.setItem('token', data.token);
            localStorage.setItem('role', data.role);
            localStorage.setItem('name', data.name);
            localStorage.setItem('zone', data.zone || '');

            console.log("Login exitoso. Redirigiendo...");

            // 5. Redirección forzada
            window.location.replace('/dashboard.html');

        } catch (error) {
            console.error("Error Login:", error);

            // Mostrar error al usuario
            msgElement.textContent = "❌ " + error.message;

            // Restaurar botón
            btnSubmit.disabled = false;
            btnSubmit.textContent = 'Ingresar';
            btnSubmit.style.opacity = '1';
        }
    });
</script>

</body>
</html>
