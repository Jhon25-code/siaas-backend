<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SIAAS | Acceso</title>


    <!-- RUTA RELATIVA (Android Studio + Express friendly) -->
    <link rel="stylesheet" href="./css/styles.css" />
</head>

<body class="loginPage">

<script defer>
    try {
        const token = localStorage.getItem('token');
        // Validación básica de JWT
        if (token && token.split('.').length === 3) {
            window.location.href = './dashboard.html';
        } else {
            localStorage.clear();
        }
    } catch {
        localStorage.clear();
    }
</script>

<section class="loginHero" aria-hidden="true"></section>

<main class="loginWrap">
    <section class="loginCard" aria-label="Acceso al sistema">

        <header class="brand">
            <img
                    class="brandLogo"
                    src="./images/logo_siaas.png"
                    alt="Logo SIAAS"
                    onerror="this.style.display='none'"
            />
            <div class="brandText">
                <h1>SIAAS</h1>
                <p>Sistema inteligente de alertas agrícolas</p>
            </div>
        </header>

        <div class="divider"></div>

        <form
                id="loginForm"
                autocomplete="off"
                autocapitalize="off"
                spellcheck="false"
        >
            <label for="username">Usuario</label>
            <input
                    id="username"
                    name="username"
                    type="text"
                    placeholder="topico / admin / supervisor"
                    required
                    autofocus
            />

            <label for="password">Contraseña</label>
            <input
                    id="password"
                    name="password"
                    type="password"
                    placeholder="Siaas2026"
                    required
            />

            <button class="btnPrimary" type="submit" id="btnSubmit">
                Ingresar
            </button>

            <p
                    id="msg"
                    class="error"
                    aria-live="polite"
                    style="color:#d32f2f;margin-top:1rem;font-weight:500;"
            ></p>
        </form>

        <footer class="loginFooter">
            © <span id="year"></span> Agroindustrial · SIAAS
        </footer>

    </section>
</main>

<script defer>
    document.getElementById('year').textContent =
        new Date().getFullYear();
</script>

<script defer>
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const msg = document.getElementById('msg');
        const btn = document.getElementById('btnSubmit');
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        msg.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Verificando...';
        btn.style.opacity = '0.7';

        try {
            // Limpieza preventiva
            localStorage.clear();

            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Credenciales inválidas');
            }

            // Guardar sesión
            localStorage.setItem('token', data.token);
            localStorage.setItem('role', data.role);
            localStorage.setItem('name', data.name);
            localStorage.setItem('zone', data.zone || '');

            // Redirección segura
            window.location.replace('./dashboard.html');

        } catch (error) {
            msg.textContent = '❌ ' + error.message;
            btn.disabled = false;
            btn.textContent = 'Ingresar';
            btn.style.opacity = '1';
        }
    });
</script>

</body>
</html>
